/**
     * @author: 
     *    jiangrun002
     * @version: 
     *    v0.2.0
     * @license:
     *    Copyright 2017, jiangrun. All rights reserved.
     */

var Tgc2=function(){function t(e){var i=this;this.availableData={},this.beforeChartUpdate=[],this.beforeDestory=[],this.beforeDraw=[],this.beforeInit=[],this.beforeLoad=[],this.data={},this.emphasesColor="#faa01b",this.extendData={},this.historyList=[],this.isInit=!1,this.linkColor="#666",this.localization={closeButton:"关闭",dataRequestFailed:"请求数据失败",loadingLabel:"加载中...",menu:{collapse:"折叠",close:"关闭",dynamic:"动态",expand:"展开",fixed:"固定",focus:"焦点",hide:"隐藏",unfocus:"取消焦点"},toolbar:{backButton:"返回上一步",backTitle:"回退一步",exportButton:"导出",exportCSV:"导出为CSV文件",exportJpeg:"导出为JPEG文件",exportPDF:"导出为PDF文件",exportPNG:"导出为PNG文件",exportTitle:"导出数据",exportXLS:"导出为XLS文件",fitButton:"适合按钮",fitTitle:"适合屏幕",freezeButton:"锁定按钮",freezeTitle:"全部锁定",fullscreenButton:"全屏",fullscreenTitle:"切换全屏模式",rearrangeButton:"重新排列",rearrangeTitle:"重新排列元素",unfreezeTitle:"解锁全部",zoomoutButton:"缩放按钮",zoomoutTitle:"缩放"}},this.nodeColor="#00b38a",this.nodeIds={},this.onAvailableDataUpdate=[],this.onChartUpdate=[],this.onClear=[],this.onResize=[],this.onDataUpdate=[],this.onInit=[],this.onLoadSuccess=[],this.onVisibleDataUpdate=[],this.pathIds={},this.reduceColor="#ddd",this.selectionColor="#9aabeb",this.visibleData={},this.netChartSettings={container:"",area:{},style:{nodeDetailMinSize:10,selection:{fillColor:this.selectionColor,sizeProportional:.3},nodeSelected:{radius:50},node:{fillColor:this.nodeColor,imageCropping:"crop"},link:{fillColor:this.linkColor},linkLabel:{backgroundStyle:{lineWidth:0},rotateWithLink:!0},nodeStyleFunction:function(t){i.nodeStyleFunction(t)},linkStyleFunction:function(t){i.linkStyleFunction(t)}},auras:{cellSize:4,overlap:!0,enabled:!0,defaultStyle:{shadowColor:"#fff",showInLegend:!0},style:{}},nodeMenu:{},navigation:{focusNodeExpansionRadius:0,numberOfFocusNodes:1},info:{enabled:!0,linkContentsFunction:function(e){return t.linkContentsFunction(e)}},events:{onDoubleClick:function(t,e){i.onDoubleClick(t,e)}},filters:{nodeFilter:function(t){return!t.hidden},linkFilter:function(t){return!t.hidden}},toolbar:{enabled:!0,"export":!0},localization:this.localization},this.end="",this.forceRefresh=!1,this.settings={selector:"",extend:!1,netChart:{relayout:!1,history:!1,nodeDefaultColor:this.nodeColor,linkDefaultColor:this.linkColor,emphasesColor:this.emphasesColor,reduceColor:this.reduceColor,style:{top:"0px",right:"0px",bottom:"0px",left:"0px"},settings:{}},loader:$.noop},this.start="",this.settings.netChart.settings=this.netChartSettings,$.extend(!0,this.settings,e),this.resetToolbar()}return t.prototype.addBeforeChartUpdate=function(t){this.beforeChartUpdate.push(t)},t.prototype.addBeforeDestory=function(t){this.beforeDestory.push(t)},t.prototype.addBeforeDraw=function(t){this.beforeDraw.push(t)},t.prototype.addBeforeInitEvent=function(t){this.beforeInit.push(t)},t.prototype.addBeforeLoad=function(t){this.beforeLoad.push(t)},t.prototype.addControls=function(t,e){var i=$('<div class="tgc2-right-panels-tab tgc2-right-panels-button"><i class="tgc2-right-panels-tab-arrow"></i></div>');i.prepend(t),this.getContainer().find(".tgc2-right-panels-buttons").append(i);var n=$('<div class="chart-control-panel"></div>');n.append(e),this.getContainer().find(".tgc2-right-panels-pages").append(n)},t.prototype.addPanels=function(t,e){this.select(".tgc2-left-panels").length||this.buildLeftPanels();var i=this.getContainer().find(".tgc2-left-panels .nav").find("li").length,n=i?"":"active",a="tab-"+(new Date).getTime()+"-"+i;this.getContainer().find(".tgc2-left-panels .nav").append('<li role="presentation" class="'+n+'"><a href="#'+a+'" role="tab" data-toggle="tab" aria-expanded="true">'+t+"</a></li>"),this.getContainer().find(".tgc2-left-panels .nav").children("li").css("width",100/(i+1)+"%"),this.getContainer().find(".tgc2-left-panels .tab-content").append('<div role="tabpanel" class="tab-pane '+n+'" id="'+a+'">'+e+"</div>")},t.prototype.addOnAvailableDataUpdate=function(t){this.onAvailableDataUpdate.push(t)},t.prototype.addOnChartUpdate=function(t){this.onChartUpdate.push(t)},t.prototype.addOnClear=function(t){this.onClear.push(t)},t.prototype.addOnDataUpdate=function(t){this.onDataUpdate.push(t)},t.prototype.addOnResize=function(t){this.onResize.push(t)},t.prototype.addOnVisibleDataUpdate=function(t){this.onVisibleDataUpdate.push(t)},t.prototype.addOnInitEvent=function(t){this.onInit.push(t)},t.prototype.addOnLoadSuccess=function(t){this.onLoadSuccess.push(t)},t.prototype.back=function(){this.historyList.length>1&&(this.historyList.pop(),this.historyList.length&&this.getGraphData(this.historyList[this.historyList.length-1])),1==this.historyList.length&&this.select(".chart-his").addClass("disabled DVSL-bar-disabled")},t.prototype.clear=function(){this.settings.extend||(this.data={nodes:[],links:[]},this.availableData=this.data,this.visibleData=this.data),t.callEvent(this.onClear)},t.prototype.clearEmphasesNode=function(){this.nodeIds={}},t.prototype.clearEmphasesPath=function(){this.pathIds={}},t.prototype.destroy=function(){this.$container&&(t.callEvent(this.beforeDestory),this.isInit=!1,this.$container.removeClass("tgc2").empty(),this.$container=null)},t.prototype.getContainer=function(){return this.$container},t.prototype.getAvailableData=function(){return this.availableData},t.prototype.getData=function(){return this.data},t.prototype.getVisibleData=function(){return this.visibleData},t.prototype.init=function(){this.isInit||(t.callEvent(this.beforeInit),this.$container=$(this.settings.selector).addClass("tgc2"),this.initTemplate(),this.initNetChart(),t.callEvent(this.onInit),this.isInit=!0)},t.prototype.load=function(t){this.isInit||this.init(),this.historyList.push(t),this.getGraphData(t)},t.prototype.resize=function(){this.netChart.updateSize(),t.callEvent(this.onResize)},t.prototype.select=function(t){return this.getContainer().find(t)},t.prototype.setEmphasesNode=function(t){for(var e={},i=0,n=t;i<n.length;i++){var a=n[i];e[a]=!0}this.nodeIds=e},t.prototype.setEmphasesPath=function(t){for(var e={},i=0,n=t;i<n.length;i++){var a=n[i];e[a]=!0}this.pathIds=e},t.prototype.updateChart=function(){t.callEvent(this.beforeChartUpdate);for(var e=0,i=this.availableData.nodes;e<i.length;e++){var n=i[e];this.inStart(n.id)?n.hidden=!1:this.visibleData.nodes&&this.visibleData.nodes.length&&this.visibleData.links&&this.visibleData.links.length?n.hidden=_.indexOf(this.visibleData.nodes,n.id)<0:n.hidden=!1}for(var a=0,s=this.availableData.links;a<s.length;a++){var o=s[a];this.visibleData.nodes&&this.visibleData.nodes.length&&this.visibleData.links&&this.visibleData.links.length?o.hidden=_.indexOf(this.visibleData.links,o.id)<0:o.hidden=!1}this.netChart.replaceData(this.availableData),t.callEvent(this.onChartUpdate)},t.prototype.updateAvailableData=function(e){this.availableData=e,t.callEvent(this.onAvailableDataUpdate)},t.prototype.updateData=function(e){this.data=e,t.callEvent(this.onDataUpdate)},t.prototype.updateVisibleData=function(e){this.visibleData=e,t.callEvent(this.onVisibleDataUpdate)},t.prototype.buildLeftPanels=function(){var t='<div class="tgc2-left-panels"><ul class="nav nav-tabs" role="tablist"></ul><div class="tab-content"></div></div>';this.getContainer().append(t)},t.callEvent=function(t){for(var e=0,i=t;e<i.length;e++){var n=i[e];n()}},t.prototype.drawResult=function(){this.availableData=this.data,t.callEvent(this.beforeDraw),this.updateResult(),this.updateChart()},t.prototype.getGraphData=function(e){var i=this;this.startInfo=e,t.callEvent(this.beforeLoad),this.clear(),this.forceRefresh||!this.extendData[e.id]?this.settings.loader(this,function(n){i.extendData[e.id]=$.extend(!0,{},n),i.data=$.extend(!0,{},i.extendData[e.id]),i.updateStartInfo(),t.callEvent(i.onLoadSuccess),i.drawResult()}):(this.data=$.extend(!0,{},this.extendData[e.id]),this.drawResult())},t.prototype.initButtonEvent=function(){var t=this;this.select(".chart-his").on("click",function(){t.back()}),this.select(".chart-reset").on("click",function(){t.netChart.resetLayout()}),this.select(".tgc2-right-panels-buttons").on("click",".tgc2-right-panels-tab",function(){var t=$(this),e=t.closest(".tgc2-right-panels"),i=t.prev(".tgc2-right-panels-button").length,n=$(e.find(".tgc2-right-panels-pages").children()[i]);t.hasClass("active")?(t.removeClass("active"),e.removeClass("active"),n.removeClass("active")):(t.addClass("active"),e.addClass("active"),n.addClass("active")),t.siblings(".active").removeClass("active"),n.siblings(".active").removeClass("active")})},t.prototype.initNetChart=function(){var t=this.settings.netChart.settings;!t.container&&(t.container=this.getContainer().find(".tgc2-netchart-container")[0]),this.netChart=new NetChart(t)},t.prototype.initTemplate=function(){var t=$('<div class="tgc2-netchart-container"></div>'),e='<div class="tgc2-right-panels-buttons">';this.settings.netChart.relayout&&(e+='<div class="chart-reset tgc2-right-panels-button"><p>重新<br>布局</p></div>'),this.settings.netChart.history&&(e+='<div class="chart-his disabled tgc2-right-panels-button"><p>返回<br>上一步</p></div>'),e+="</div>";var i='<div class="tgc2-right-panels">'+e+'<div class="tgc2-right-panels-pages"></div></div>';t.css({top:this.settings.netChart.style.top,right:this.settings.netChart.style.right,bottom:this.settings.netChart.style.bottom,left:this.settings.netChart.style.left}),this.getContainer().append(t),this.getContainer().append(i),this.initButtonEvent()},t.linkContentsFunction=function(t){return t.typeName},t.prototype.linkStyleFunction=function(t){t.label=t.data.typeName,t.toDecoration="arrow",t.fillColor=t.data.color||this.settings.netChart.linkDefaultColor||t.fillColor,this.pathIds[t.id]?(t.fillColor=this.settings.netChart.emphasesColor,t.label=t.data.typeName,t.radius=3*t.radius):$.isEmptyObject(this.pathIds)||(t.fillColor=this.settings.netChart.reduceColor,t.label="")},t.prototype.nodeStyleFunction=function(t){t.label=t.data.name,t.lineWidth=2,t.fillColor=t.data.color||this.settings.netChart.nodeDefaultColor||t.fillColor,t.labelStyle.textStyle.font="18px Microsoft Yahei",t.aura=t.data.auras,this.inStart(t.id)&&(t.radius=50,t.fillColor=this.settings.netChart.emphasesColor),this.nodeIds[t.id]?(t.fillColor=this.settings.netChart.emphasesColor,t.label=t.data.name,t.radius=1.5*t.radius):$.isEmptyObject(this.nodeIds)||(t.fillColor=this.settings.netChart.reduceColor,t.radius=.5*t.radius)},t.prototype.onDoubleClick=function(t,e){},t.prototype.resetToolbar=function(){var t=this,e=this.settings.netChart.settings;if(e.toolbar.enabled){if(e.toolbar.extraItems=e.toolbar.extraItems||[],e.toolbar.back!==!1){e.toolbar.back=!1;var i=e.localization.toolbar.backButton;e.toolbar.extraItems.push({label:i,cssClass:"DVSL-bar-btn-back DVSL-bar-disabled chart-his disabled",onClick:function(){t.back()}})}if(e.toolbar.fullscreen!==!1){e.toolbar.fullscreen=!1;var i=e.localization.toolbar.fullscreenTitle;e.toolbar.extraItems.push({label:i,cssClass:"DVSL-bar-btn-fullscreen",onClick:function(e){$(e.target).closest(".DVSL-bar-btn").toggleClass("DVSL-bar-btn-fullscreen DVSL-bar-btn-fullscreen-active"),t.$container.toggleClass("fullscreen")}})}}},t.prototype.updateResult=function(){this.select(".tgc2-netchart-nodata").remove(),this.availableData.nodes.length||this.select(".tgc2-netchart-container").append('<div class="tgc2-netchart-nodata">没有相关数据</div>')},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Tgc2Graph=function(t){function e(e){t.call(this,e)}return __extends(e,t),e.prototype.inStart=function(t){return this.startInfo.id==t},e.prototype.onDoubleClick=function(t,e){if(e.clickNode){this.select(".chart-his").removeClass("disabled DVSL-bar-disabled");var i=e.clickNode.data;this.historyList.push(i),this.getGraphData(i)}},e.prototype.updateStartInfo=function(){var t=this;this.startInfo=_.find(this.data.nodes,function(e){return e.id==t.startInfo.id})},e}(Tgc2),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Tgc2Path=function(t){function e(e){var i=this;t.call(this,e),this.addOnInitEvent(function(){i.initPathPanel()}),this.addBeforeLoad(function(){i.initPathStartInfo()})}return __extends(e,t),e.prototype.initPathPanel=function(){var t=this,e="定向分析",i='<div class="tgc2-path"><div class="tgc2-path-prompt-container"><div class="tgc2-path-label">起点：</div><div class="tgc2-path-start"></div></div><div class="tgc2-path-prompt-container"><div class="tgc2-path-label">终点：</div><div class="tgc2-path-end"></div></div><div class="tgc2-path-preview"><button class="btn btn-primary btn-preview">预览</button></div></div>';this.addPanels(e,i);var n={onSearch:function(t,e){e.find('input[type="text"]').val(t.name),e.data("data",t)},onSelectItemChange:function(t,e){if(t){var i=e.find('input[type="text"]').val();t.name==i&&e.data("data",t)}else e.removeData("data")},onSearchTextChange:function(t,e){e.removeData("data")}},a=$.extend(!0,{},n,this.settings.path.prompt.settings),s=$.extend(!0,{},n,this.settings.path.prompt.settings);a.container=".tgc2-path-start",s.container=".tgc2-path-end",this.startPrompt=new hieknPrompt(a),this.endPrompt=new hieknPrompt(s),this.select(".tgc2-path-preview .btn-preview").on("click",function(){var e=t.select(".tgc2-path-start").data("data"),i=t.select(".tgc2-path-end").data("data");if(e&&i){var n={};n.id=e.id+"-"+i.id,n.start=e,n.end=i,t.startInfo=n,t.load(n)}else toastr.error("起点和终点不能为空")})},e.prototype.initPathStartInfo=function(){this.startInfo.start&&this.startInfo.start.name&&(this.select(".tgc2-path-start").data("data",this.startInfo.start),this.select(".tgc2-path-start").find("input").val(this.startInfo.start.name)),this.startInfo.end&&this.startInfo.end.name&&(this.select(".tgc2-path-end").data("data",this.startInfo.end),this.select(".tgc2-path-end").find("input").val(this.startInfo.end.name)),this.startInfo.id="id-"+(new Date).getTime()},e.prototype.inStart=function(t){return this.startInfo.start.id==t||this.startInfo.end.id==t},e.prototype.updateStartInfo=function(){var t=this,e=_.find(this.data.nodes,function(e){return e.id==t.startInfo.start.id}),i=_.find(this.data.nodes,function(e){return e.id==t.startInfo.end.id});e&&(this.startInfo.start=e),i&&(this.startInfo.end=i),this.initPathStartInfo()},e}(Tgc2),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Tgc2Relation=function(t){function e(e){var i=this;t.call(this,e),this.addOnInitEvent(function(){i.initPathPanel()}),this.addBeforeLoad(function(){i.initRelationStartInfo()})}return __extends(e,t),e.prototype.initPathPanel=function(){var t=this,e="定向分析",i='<div class="tgc2-relation"><div class="tgc2-relation-prompt-container"><div class="tgc2-relation-label">添加对象：</div><div class="tgc2-relation-prompt"></div></div><div class="tgc2-relation-data-container"><div class="tgc2-relation-data-title">分析对象</div><ul></ul></div><div class="tgc2-relation-preview"><button class="btn btn-primary btn-preview">预览</button></div></div>';this.addPanels(e,i);var n={onSearch:function(e,i){i.find('input[type="text"]').val(""),t.addRelationNode(e)}},a=$.extend(!0,{},n,this.settings.relation.prompt.settings);a.container=".tgc2-relation-prompt",this.relationPrompt=new hieknPrompt(a),this.select(".tgc2-relation-preview .btn-preview").on("click",function(){var e=t.getRelationNodes();if(e.length>1){var i={};i.nodes=e,t.startInfo=i,t.load(i)}else toastr.error("分析对象不能少于两个")}),this.select(".tgc2-relation-data-container").on("click","li svg",function(e){t.removeRelationNode(e)})},e.prototype.addRelationNode=function(t){if(this.inRelationNodes(t))return void toastr.error("该对象已添加");if(t.name){var e=t.name;t.meaningTag&&(e+="["+t.meaningTag+"]");var i=$("<li>"+e+'<svg height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/><path d="M0 0h24v24H0z" fill="none"/></svg></li>').data("data",t);this.select(".tgc2-relation-data-container ul").append(i)}},e.prototype.getRelationNodes=function(){var t=[];return this.select(".tgc2-relation-data-container ul").children("li").each(function(e,i){t.push($(i).data("data"))}),t},e.prototype.inRelationNodes=function(t){var e=this.getRelationNodes();return!!_.find(e,function(e){return e.id==t.id})},e.prototype.removeRelationNode=function(t){$(t.target).closest("li").remove()},e.prototype.initRelationStartInfo=function(){this.select(".tgc2-relation-data-container ul").empty();for(var t=0,e=this.startInfo.nodes;t<e.length;t++){var i=e[t];this.addRelationNode(i)}this.startInfo.id="id-"+(new Date).getTime()},e.prototype.inStart=function(t){return!!_.find(this.startInfo.nodes,function(e){return e.id==t})},e.prototype.updateStartInfo=function(){var t=this.startInfo.nodes,e=function(e){i.startInfo.nodes[e]=_.find(i.data.nodes,function(i){return i.id==t[e].id})},i=this;for(var n in this.startInfo.nodes)e(n);this.initRelationStartInfo()},e}(Tgc2),Tgc2Connects=function(){function t(e,i){var n=this;this.tgc2=e,this.settings=$.extend(!0,{},t.defaultSettings,i),this.tgc2.addOnInitEvent(function(){n.initTemplate()}),this.tgc2.addBeforeDraw(function(){return n.beforeDraw()})}return t.prototype.getContainer=function(){return this.$container},t.prototype.select=function(t){return this.getContainer().find(t)},t.prototype.initEvent=function(){var t=this;t.getContainer().on("mouseenter",".tgc2-connects-content",function(){var e=$(this).data("data"),i=e.nodes,n=e.edges;t.tgc2.setEmphasesNode(i),t.tgc2.setEmphasesPath(n),t.tgc2.netChart.updateStyle()}),t.getContainer().on("mouseleave",".tgc2-connects-content",function(){t.tgc2.clearEmphasesNode(),t.tgc2.clearEmphasesPath(),t.tgc2.netChart.updateStyle()})},t.prototype.initTemplate=function(){if(this.settings.enable){var t="图解读",e='<div class="tgc2-connects"></div>';this.tgc2.addPanels(t,e),this.$container=this.tgc2.select(".tgc2-left-panels"),this.initEvent()}},t.prototype.beforeDraw=function(){var t=this.tgc2.getData();this.drawData(t)},t.prototype.drawData=function(t){var e=t.connects;this.select(".tgc2-connects").empty();var i="";if(e&&e.length){var n=function(n){var s=e[n],o=_.find(t.nodes,function(t){return t.id==s.start}),r=_.find(t.nodes,function(t){return t.id==s.end}),l=o.name,c=r.name,h=$('<div class="tgc2-connects-content"><div class="tgc2-connects-index">'+(parseInt(n)+1)+'</div><div class="tgc2-connects-detail"><div class="tgc2-connects-subtitle"><i></i>'+l+"<span></span>"+c+'</div><ul class="tgc2-connects-ul"></ul></div></div>');a.select(".tgc2-connects").append(h),s.edges&&s.edges.length?(s.edges.forEach(function(e,i){var n=_.find(t.nodes,function(t){return t.id==s.nodes[i]}),a=_.find(t.nodes,function(t){return t.id==s.nodes[i+1]}),l=n.name,c=a.name,d=_.find(t.links,function(t){return t.id==e}),p=d.typeName,f=d.from==n.id?"tgc2-arrow-to":"tgc2-arrow-from",g=n.id==o.id,u=a.id==r.id,v="";if(d.rInfo)for(var b=0,m=d.rInfo;b<m.length;b++){var y=m[b],C=y.kvs;for(var D in C)C.hasOwnProperty(D)&&(v+="<li>"+C[D].v+"</li>")}var w=$('<li class="tgc2-connects-li"><div><span class="'+(g?"tgc2-connects-start":"")+'">'+l+'</span><span class="tgc2-arrow '+f+'">'+p+'</span><span class="'+(u?"tgc2-connects-end":"")+'">'+c+'</span></div><ul class="tgc2-connects-li-sub">'+v+"</ul></li>");h.find(".tgc2-connects-ul").append(w)}),h.data("data",s),a.select(".tgc2-connects").append(h)):i='<div class="no-data">暂无数据</div>'},a=this;for(var s in e)n(s)}else i='<div class="no-data">暂无数据</div>';i&&this.select(".tgc2-connects").append(i)},t.defaultSettings={enable:!1},t}(),Tgc2Event=function(){function t(e,i){var n=this;this.events=[],this.showEvents=[],this.visibleEvents=[],this.start="",this.end="",this.tgc2=e,this.settings=$.extend(!0,{},t.defaultSettings,i),this.tgc2.addOnInitEvent(function(){n.initTemplate()}),this.tgc2.addBeforeDraw(function(){n.beforeDraw()}),this.tgc2.addOnChartUpdate(function(){n.buildEvents(),n.drawEvents()})}return t.prototype.drawEvents=function(){var t="",e=null,i=this.select(".tgc2-event-content-container"),n=$.extend(!0,{},this.visibleEvents);n=this.settings.groupEvent(n),n=_.orderBy(n,["timestamp"],["desc"]),this.showEvents=n,i.find(".tgc2-event-year-item-container").remove();var a="",s=0;for(var o in n){var r=n[o],l=this.tgc2.getVisibleData();if(l.nodes&&l.nodes.length&&l.links&&l.links.length){if(_.union(l.links,r.ids).length===l.links.length+r.ids.length)continue;if(r.from!=this.tgc2.startInfo.id&&_.union(l.nodes,r.fromIds).length===l.nodes.length+r.fromIds.length)continue;if(r.to!=this.tgc2.startInfo.id&&_.union(l.nodes,r.toIds).length===l.nodes.length+r.toIds.length)continue}s++,t!=r.year&&(t=r.year,e?e.html(a)&&i.append(e):"",e=$('<div class="tgc2-event-year-item-container"></div>'),a="");var c="";if(_.isArray(r.detail.t2))for(var h=0,d=r.detail.t2;h<d.length;h++){var p=d[h];c+='<div class="color-gray-999" title="'+p+'">'+p+"</div>"}else c='<div class="color-gray-999" title="'+r.detail.t2+'">'+r.detail.t2+"</div>";a+='<div class="tgc2-event-item" data-index="'+o+'"><div class="tgc2-event-time"><div class="tgc2-event-year">'+r.year+'</div><div class="tgc2-event-day">'+r.day+'</div></div><div class="tgc2-event-pointer"><div class="tgc2-event-pointer"></div></div><table class="event-detail"><tr><td><span class="color-primary">'+r.detail.type+'</span></td><td><div class="color-primary" title="'+r.detail.t2+'">'+r.detail.t3+'</div></td></tr><tr><td colspan="2">'+r.detail.t1+c+'</td></tr><tr><td colspan="2">'+r.detail.t4+'<div class="color-gray-999" title="'+r.detail.t5+'">'+r.detail.t5+"</div></td></tr></table></div>"}e?e.html(a)&&i.append(e):"",this.select(".tgc2-event-time-range").text(this.start+" 至 "+this.end),this.select(".tgc2-event-item-count").text(s)},t.prototype.getContainer=function(){return this.$container},t.prototype.select=function(t){return this.getContainer().find(t)},t.prototype.beforeDraw=function(){this.updateEventDetail(this.tgc2.getData())},t.prototype.buildEvents=function(){this.start=this.tgc2.start,this.end=this.tgc2.end;var t=new Date(this.start).getTime(),e=new Date(this.end).getTime();this.visibleEvents=_.filter(this.events,function(i){return i.timestamp>=t&&i.timestamp<=e})},t.groupEvent=function(t){var e=[],i=_.groupBy(t,"meaningId");for(var n in i){var a=[],s=[],o=[],r=[];for(var l in i[n])a.push(i[n][l].detail.t2),s.push(i[n][l].from),o.push(i[n][l].to),r.push(i[n][l].id);i[n][0].fromIds=_.uniq(s),i[n][0].toIds=_.uniq(o),i[n][0].ids=_.uniq(r),i[n][0].detail.t2=_.uniq(a),e.push(i[n][0])}return e},t.prototype.initEvent=function(){var t=this;this.getContainer().on("mouseenter",".tgc2-event-item",function(){var e=t.showEvents[$(this).attr("data-index")];t.tgc2.setEmphasesPath(e.ids||[e.id]);var i=[];i=e.fromIds&&e.toIds?_.union(e.fromIds,e.toIds):[e.from,e.to],t.tgc2.setEmphasesNode(i),t.tgc2.netChart.updateStyle()}).on("mouseleave",".tgc2-event-item",function(){t.tgc2.clearEmphasesPath(),t.tgc2.clearEmphasesNode(),t.tgc2.netChart.updateStyle()})},t.prototype.initTemplate=function(){this.settings.enable&&(this.$container=$('<div class="tgc2-event"><div class="tgc2-event-title"><svg fill="#00b38a" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg><div class="tgc2-event-title-container"><div><span class="tgc2-event-time-range">-</span></div><div>发生事件总数：<span class="tgc2-event-item-count">0</span></div></div></div><div class="tgc2-event-content"><div class="tgc2-event-content-container"><div class="tgc2-event-content-line"></div></div></div></div>'),this.$container.css({top:this.settings.style.top,right:this.settings.style.right,bottom:this.settings.style.bottom,left:this.settings.style.left,width:this.settings.style.width}),this.tgc2.getContainer().append(this.$container),this.initEvent())},t.prototype.updateEventDetail=function(e){e.computerTime?this.events=t.updateEventInfo(e.links):this.events=e.links;for(var i=function(t){var i=_.find(e.nodes,function(e){return e.id==t.from}),a=_.find(e.nodes,function(e){return e.id==t.to});t.detail=n.settings.gentEventDetail(i,a,t)},n=this,a=0,s=this.events;a<s.length;a++){var o=s[a];i(o)}},t.updateEventInfo=function(t){for(var e=[],i=0,n=t;i<n.length;i++)for(var a=n[i],s=0,o=a.bsTime;s<o.length;s++){var r=o[s],l=$.extend(!0,{},a),c=new Date(r);l.timestamp=c.getTime(),l.year=c.getFullYear(),l.day=_.padStart(c.getMonth()+1,2,0)+"-"+_.padStart(c.getDate(),2,0),e.push(l)}return e},t.defaultSettings={enable:!1,style:{top:"0",right:"auto",bottom:"40px",left:"0",width:"320px"},gentEventDetail:$.noop,groupEvent:function(e){return t.groupEvent(e)}},t}(),Tgc2Facet=function(){function t(e,i){var n=this;this.facet={brush:{isBrush:!1,arrBrush:[],series:{all:{}}}},this.tgc2=e,this.settings=$.extend(!0,{},t.defaultSettings,i),this.tgc2.addBeforeDraw(function(){return n.beforeDraw()}),this.tgc2.addOnInitEvent(function(){n.initTemplate()}),this.tgc2.addOnLoadSuccess(function(){n.onLoadSuccess()}),this.tgc2.addOnAvailableDataUpdate(function(){n.drawFacetPanel()}),this.tgc2.addOnClear(function(){n.clearSelectedFacet()}),this.tgc2.addBeforeChartUpdate(function(){n.updateAuras()})}return t.prototype.clearSelectedFacet=function(){this.select(".tgc2-facet-selected>*").empty()},t.prototype.getContainer=function(){return this.$container},t.prototype.removeFacetByTag=function(t){this.select(".tgc2-facet-selected").find('li[tag="'+t+'"]').remove(),this.select(".tgc2-facet-control-container").find('li[tag="'+t+'"]').removeClass("selected")},t.prototype.select=function(t){return this.getContainer().find(t)},t.prototype.beforeDraw=function(){this.drawFacetName(),this.drawFacetPanel(),this.updateColor()},t.prototype.brushColor=function(){var t=this;this.facet.brush.arrBrush=[],this.select(".tgc2-facet-control-container>.tab-content>.tab-pane.active").find(".tab-pane.active").find("li").each(function(e,i){var n=$(i).attr("tag");t.facet.brush.isBrush?($(i).css({background:t.facet.brush.series.all[n].fillColor}),t.facet.brush.arrBrush.push(n)):$(i).removeAttr("style")}),this.tgc2.updateChart()},t.prototype.drawFacetName=function(){var t=this,e=this.tgc2.startInfo.name||_.find(this.tgc2.getData().nodes,function(e){return e.id==t.tgc2.startInfo.id}).name;this.select(".ctrl-filter-ent").text(e)},t.prototype.drawFacetPanel=function(){var t=this.getEventsFacet(this.tgc2.getData().links),e=_.countBy(t),i=_.countBy(this.getEventsFacet(this.tgc2.getAvailableData().links));t=_.union(t);var n=[],a=[],s=this.select(".tgc2-facet-control-container");s.find(".nav-tabs>li.active>a").each(function(t,e){n.push($(e).attr("href"))}),this.select(".tgc2-facet-selected li").each(function(t,e){a.push($(e).attr("tag"))}),s.html('<div class="table-angle"><div class="table-angle-line1">数据</div><div class="table-angle-line2">条件</div></div><ul class="nav nav-tabs" role="tablist"></ul><div class="tab-content">'),t.reverse();for(var o in t){var r=_.split(t[o],"->"),l=s.children(".tab-content").children("#level1-"+r[0]);if(!l.length){var c="0"==o?"active":"";l=$('<div role="tabpanel" class="tab-pane '+c+'" id="level1-'+r[0]+'"><ul class="nav nav-tabs" role="tablist"></ul><div class="tab-content"></div></div>'),s.children(".tab-content").append(l),s.children(".nav").append('<li role="presentation" class="'+c+'"><a href="#level1-'+r[0]+'" role="tab" data-toggle="tab">'+this.settings.facetMap[r[0]]+"</a></li>");var h=s.children(".nav").children();h.width(Math.floor(100/h.length)+"%")}var d=l.find("#level2-"+r[1]);if(!d.length){var p=0==l.find(".nav").children().length?"active":"";d=$('<div role="tabpanel" class="tab-pane '+p+'" id="level2-'+r[1]+'"><ul class="clearfix"></ul></div>'),l.find(".tab-content").append(d),l.find(".nav").append('<li role="presentation" class="'+p+'"><a href="#level2-'+r[1]+'" role="tab" data-toggle="tab">'+r[1]+"</a></li>");var f=l.find(".nav").children();f.height(Math.floor(100/f.length)+"%")}var g=_.indexOf(a,t[o])>=0?"selected":"",u=$('<li class="tgc2-facet-filter-item '+g+'" tag="'+t[o]+'">'+r[2]+"（"+(i[t[o]]||0)+"/"+e[t[o]]+"）</li>");d.find("ul").append(u),_.indexOf(this.facet.brush.arrBrush,t[o])>=0&&u.css({"background-color":this.facet.brush.series.all[t[o]].fillColor})}for(var v in n)this.select('a[href="'+v+'"]').tab("show")},t.prototype.getEventsFacet=function(t){var e=_.union(_.map(t,"from"),_.map(t,"to"));return e=_.filter(this.tgc2.getData().nodes,function(t){return _.indexOf(e,t.id)>=0&&t.facets}),_.flatten(_.map(e,"facets"))},t.prototype.initEvent=function(){var t=this;t.select(".ctrl-color").on("click",function(e){$(this).toggleClass("selected"),t.facet.brush.isBrush=!t.facet.brush.isBrush,t.brushColor(),e.stopPropagation()}),t.select(".tgc2-facet-control-title").on("click",function(){t.getContainer().toggleClass("on")}),t.select(".tgc2-facet-control-container").on("click",".tgc2-facet-filter-item",function(){var e=$(this).toggleClass("selected"),i=e.attr("tag");if(e.hasClass("selected")){var n=e.text().split("（"),a=$('<li tag="'+i+'">'+n[0]+'<svg fill="#666" height="12" viewBox="0 0 24 24" width="12" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/><path d="M0 0h24v24H0z" fill="none"/></svg></li>');t.select(".tgc2-facet-selected ul").append(a),"0"==n[1].split("/")[0]&&toastr.info("当前数据不在筛选时间段内，如需查看，请拖动扩大图谱底部时间轴覆盖范围。")}else t.removeFacetByTag(i);t.updateVisibleData(),t.settings.afterItemChange(t)}),t.select(".tgc2-facet-selected").on("click","li",function(){var e=$(this).attr("tag");t.removeFacetByTag(e),t.updateVisibleData(),t.settings.afterItemChange(t)}),t.select(".tgc2-facet-control-container").on("shown.bs.tab",'a[data-toggle="tab"]',function(){try{t.brushColor()}catch(e){$.noop()}})},t.prototype.initTemplate=function(){this.settings.enable&&(this.$container=$('<div class="tgc2-facet-control"><div class="tgc2-facet-control-title"><div class="ctrl-expend fl"><i class="arrow"></i></div><div class="ctrl-filter-off fl"><span class="fl">数据过多？尝试筛选及分类着色功能</span></div><div class="ctrl-filter fl"><div class="ctrl-filter-text fl"><div class="ctrl-filter-ent"></div><span>相关事件的筛选</span></div><div class="ctrl-color fl"><div class="btn-switch"><i></i></div><span>开启着色</span></div></div></div><div class="tgc2-facet-selected"><ul></ul><div class="detail"></div></div><div class="tgc2-facet-control-container"></div></div>'),this.$container.css({top:this.settings.style.top,right:this.settings.style.right,bottom:this.settings.style.bottom,left:this.settings.style.left,width:this.settings.style.width}),this.tgc2.getContainer().append(this.$container),this.initEvent())},t.prototype.onLoadSuccess=function(){var t=this.tgc2.getData();t.facetList&&t.facetList.length&&t.facetList.forEach(function(e){e.facetDetailList&&e.facetDetailList.length&&e.facetDetailList.forEach(function(i){var n=e.entityType+"->"+e.typeName+"->"+i.name;i.relNodeList.forEach(function(e){var i=_.find(t.nodes,function(t){return t.id==e});i.facets=i.facets||[],i.facets.push(n)}),i.relRelationList.forEach(function(e){var i=_.find(t.links,function(t){return t.id==e});i.facets=i.facets||[],i.facets.push(n)})})})},t.prototype.updateAuras=function(){for(var t=this.tgc2.getAvailableData().nodes,e=0,i=t;e<i.length;e++){var n=i[e];if(this.facet.brush.isBrush){if(n.facets){n.auras=[];for(var a=0,s=n.facets;a<s.length;a++){var o=s[a];_.indexOf(this.facet.brush.arrBrush,o)>=0&&n.auras.push(o)}}}else delete n.auras}},t.prototype.updateColor=function(){var t=this;t.select(".tgc2-facet-control-container>.tab-content>.tab-pane").each(function(e,i){$(i).find(".tab-pane").each(function(e,i){$(i).find("li").each(function(e,i){var n=$(i).attr("tag"),a=n.substring(0,n.lastIndexOf("->")),s=n.substring(n.lastIndexOf("->")+2);
t.facet.brush.series[a]=t.facet.brush.series[a]||[];var o=_.find(t.facet.brush.series[a],["key",s]);if(!o){var r=t.settings.brush.color[_.size(t.facet.brush.series.all)%t.settings.brush.color.length],l={key:s,value:r};t.facet.brush.series[a].push(l),t.facet.brush.series.all=t.facet.brush.series.all||{},t.facet.brush.series.all[n]={fillColor:r,shadowColor:"rgba(254,248,17,0.6)",shadowBlur:35}}})})}),t.updateNodeBrush()},t.prototype.updateNodeBrush=function(){this.tgc2.netChart.updateSettings({auras:{style:this.facet.brush.series.all}})},t.prototype.updateVisibleData=function(){var t=this,e=[],i=[];t.select(".tgc2-facet-control-container>.tab-content>.tab-pane").each(function(n,a){var s=[],o=[];$(a).find(".tab-pane").each(function(e,i){var n=[],a=[];$(i).find("li.selected").each(function(e,i){var s=$(i).attr("tag"),o=s.split("->"),r=_.find(t.tgc2.getData().facetList,function(t){return t.entityType==o[0]&&t.typeName==o[1]}),l=_.find(r.facetDetailList,function(t){return t.name==o[2]});n=_.union(n,l.relNodeList),a=_.union(a,l.relRelationList)}),e>0?(s=_.xor(s,n),o=_.xor(o,a)):(s=n,o=a)}),e=_.union(e,s),i=_.union(i,o)}),this.tgc2.updateVisibleData({nodes:e,links:i}),this.tgc2.updateChart()},t.defaultSettings={enable:!1,style:{top:"auto",right:"auto",bottom:"0",left:"0",width:"320px"},facetMap:[],brush:{color:["rgba(240,102,161,0.5)","rgba(189,171,242,0.5)","rgba(132,153,253,0.5)","rgba(161,162,164,0.5)","rgba(212,130,109,0.5)","rgba(249,176,143,0.5)","rgba(190,218,145,0.5)","rgba(185,211,206,0.5)","rgba(98,188,199,0.5)","rgba(253,187,231,0.5)","rgba(93,172,217,0.5)","rgba(134,203,253,0.5)","rgba(225,184,184,0.5)","rgba(218,170,118,0.5)","rgba(248,216,129,0.5)","rgba(114,187,131,0.5)","rgba(131,213,199,0.5)","rgba(101,145,150,0.5)"]},afterItemChange:$.noop},t}(),Tgc2Filter=function(){function t(e,i){var n=this;this.tgc2=e,this.settings=$.extend(!0,{},t.defaultSettings,i),this.tgc2.addOnInitEvent(function(){n.$container=n.tgc2.select(".tgc2-right-panels"),n.initTemplate()})}return t.prototype.getContainer=function(){return this.$container},t.prototype.getFilterOptions=function(){var t={};return this.tgc2.select(".tgc2-chart-filter-panel ul").each(function(e,i){var n=$(i).attr("data-name"),a=null;$(i).find('[type="radio"]').length>0?a=$(i).find('[type="radio"]:checked').val():(a=[],$(i).find('[type="checkbox"]:checked').each(function(t,e){a.push($(e).val())})),t[n]=a}),t},t.prototype.select=function(t){return this.getContainer().find(t)},t.prototype.initEvent=function(){var t=this;this.select(".tgc2-chart-filter-panel").on("click",'[type="checkbox"]',function(){$(this).closest("label").toggleClass("checked")}),this.select(".tgc2-chart-filter-panel").on("click",'[type="radio"]',function(){$(this).closest("ul").find("label").removeClass("checked"),$(this).closest("label").addClass("checked")}),this.select(".btn-filter-preview").on("click",function(){t.tgc2.load(t.tgc2.startInfo)})},t.prototype.initTemplate=function(){if(this.settings.enable){this.tgc2.forceRefresh=!0;var t="<p>筛选<br>过滤</p>",e='<div class="tgc2-chart-filter-panel"><div class="tgc2-chart-filter-body">';e+='</div><div class="tgc2-chart-filter-foot"><button class="btn btn-primary btn-filter-preview">预览</button></div>',e+="</div>",this.tgc2.addControls(t,e),this.updateFilter(),this.initEvent()}},t.gentFilterItem=function(t){var e="",i=t.key;e+='<div class="tgc2-chart-filter-title">'+t.label+'</div><div class="tgc2-chart-filter-content"><ul class="clearfix tgc2-cr-box" data-name="'+i+'">';var n=i+"-"+(new Date).getTime();for(var a in t.options){var s=n+"-"+a,o="",r="",l="";t.options instanceof Array?(l=t.options[a],r=t.options[a],l instanceof Object&&(r=t.options[a].label,l=t.options[a].value)):(l=a,r=t.options[a]),t.selected instanceof Array?(_.indexOf(t.selected,l)!=-1&&(o="checked"),e+='<li><label for="'+s+'" class="'+o+'"><div class="checkbox-img"></div><input id="'+s+'" type="checkbox" '+o+' value="'+l+'" name="'+n+'">'+r+"</label></li>"):(t.selected==l&&(o="checked"),e+='<li><label for="'+s+'" class="'+o+'"><div class="radio-img"></div><input id="'+s+'" type="radio" '+o+' value="'+l+'" name="'+n+'">'+r+"</label></li>")}return e+="</ul></div>"},t.prototype.updateFilter=function(){var e="";for(var i in this.settings.filters)e+=t.gentFilterItem(this.settings.filters[i]);this.select(".tgc2-chart-filter-body").html(e)},t.defaultSettings={enable:!1,filters:t.filters},t.filters=[],t}(),Tgc2Page=function(){function t(e,i){var n=this;this.isPageEvent=!1,this.page={pageNo:1,pageSize:10,hasNext:!0},this.tgc2=e,this.settings=$.extend(!0,{},t.defaultSettings,i),this.tgc2.addOnInitEvent(function(){n.initTemplate()}),this.tgc2.addOnLoadSuccess(function(){return n.onLoadSuccess()}),this.tgc2.addBeforeLoad(function(){n.beforeLoad()})}return t.prototype.getContainer=function(){return this.$container},t.prototype.select=function(t){return this.getContainer().find(t)},t.prototype.beforeLoad=function(){this.isPageEvent||(this.page.pageNo=1,this.page.hasNext=!0)},t.prototype.initEvent=function(){var t=this;this.select('select[name="pageSize"]').on("change",function(e){t.isPageEvent=!0,t.page.pageSize=parseInt(e.target.value,10),t.page.pageNo=1,t.tgc2.load(t.tgc2.startInfo)}),this.select(".btn-prev-page").on("click",function(){t.page.pageNo>1?(t.isPageEvent=!0,t.page.pageNo=t.page.pageNo-1,t.tgc2.load(t.tgc2.startInfo)):toastr.info("当前已经是第一页了")}),this.select(".btn-next-page").on("click",function(){t.page.hasNext?(t.isPageEvent=!0,t.page.pageNo=t.page.pageNo+1,t.tgc2.load(t.tgc2.startInfo)):toastr.info("没有更多内容了")})},t.prototype.initTemplate=function(){this.settings.enable&&(this.tgc2.forceRefresh=!0,this.$container=$('<div class="tgc2-page-container"><div>每页显示 <select name="pageSize"><option value="10">10</option><option value="20">20</option><option value="30">30</option></select> 条</div><button class="btn btn-primary-outline btn-prev-page"><svg fill="#00b38a" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M15.41 16.09l-4.58-4.59 4.58-4.59L14 5.5l-6 6 6 6z"/><path d="M0-.5h24v24H0z" fill="none"/></svg>&nbsp;上一页</button><button class="btn btn-primary-outline btn-next-page">下一页&nbsp;<svg fill="#00b38a" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.34l4.58-4.59-4.58-4.59L10 5.75l6 6-6 6z"/><path d="M0-.25h24v24H0z" fill="none"/></svg></button></div>'),this.tgc2.getContainer().append(this.$container),this.getContainer().css({top:this.settings.style.top,right:this.settings.style.right,bottom:this.settings.style.bottom,left:this.settings.style.left}),this.select('select[name="pageSize"]').val(this.settings.pageSize),this.page.pageSize=this.settings.pageSize,this.page.pageNo=this.settings.pageNo,this.initEvent())},t.prototype.onLoadSuccess=function(){var t=this.tgc2.getData();this.isPageEvent=!1,t.nodes.length<this.page.pageSize&&(this.page.hasNext=!1)},t.defaultSettings={style:{top:"auto",right:"10px",bottom:"8px",left:"auto"},enable:!1,pageNo:1,pageSize:10},t}(),Tgc2Prompt=function(){function t(t,e){var i=this;this.defaultSettings={enable:!1,style:{top:"0",right:"auto",bottom:"50px",left:"0",width:"320px"},settings:{container:".tgc2-prompt",onSearch:function(t){i.tgc2.load(t)}}},this.tgc2=t,this.settings=$.extend(!0,{},this.defaultSettings,e),this.tgc2.addOnInitEvent(function(){i.initTemplate()})}return t.prototype.getContainer=function(){return this.$container},t.prototype.select=function(t){return this.getContainer().find(t)},t.prototype.initEvent=function(){this.prompt=new hieknPrompt(this.settings.settings)},t.prototype.initTemplate=function(){this.settings.enable&&(this.$container=$('<div class="tgc2-prompt"></div>'),this.$container.css({top:this.settings.style.top,right:this.settings.style.right,bottom:this.settings.style.bottom,left:this.settings.style.left,width:this.settings.style.width}),this.tgc2.getContainer().append(this.$container),this.initEvent())},t}(),Tgc2Stats=function(){function t(e,i){var n=this;this.tgc2=e,this.settings=$.extend(!0,{},t.defaultSettings,i),this.tgc2.addOnInitEvent(function(){n.initTemplate()}),this.tgc2.addBeforeDraw(function(){return n.beforeDraw()})}return t.prototype.getContainer=function(){return this.$container},t.prototype.select=function(t){return this.getContainer().find(t)},t.prototype.initEvent=function(){var t=this;t.getContainer().on("mouseenter",".tgc2-stats-ul>li",function(){var e=[$(this).data("node")];t.tgc2.setEmphasesNode(e),t.tgc2.netChart.updateStyle()}),t.getContainer().on("mouseleave",".tgc2-stats-ul>li",function(){t.tgc2.clearEmphasesNode(),t.tgc2.netChart.updateStyle()})},t.prototype.initTemplate=function(){if(this.settings.enable){var t="图统计",e='<div class="tgc2-stats"></div>';this.tgc2.addPanels(t,e),this.$container=this.tgc2.select(".tgc2-left-panels"),this.initEvent()}},t.prototype.beforeDraw=function(){var t=this.tgc2.getData();this.drawData(t)},t.prototype.drawData=function(t){var e=t.stats;this.select(".tgc2-stats").empty();var i="";if(e&&e.length)for(var n=function(e){var n=$('<div class="tgc2-stats-content"><div class="tgc2-stats-subtitle">'+e.key+'</div><ul class="tgc2-stats-ul"></ul></div>');e.rs&&e.rs.length?(e.rs.forEach(function(e,i){var a=_.find(t.nodes,function(t){return t.id==e.id}),s=$('<li><i class="tgc2-stats-no tgc2-stats-no-'+(i+1)+'">'+(i+1)+'</i><span class="name">'+a.name+'</span><span class="num">'+e.count+"</span></li>");s.data("node",e.id),n.find(".tgc2-stats-ul").append(s)}),a.select(".tgc2-stats").append(n)):i='<div class="no-data">暂无数据</div>'},a=this,s=0,o=e;s<o.length;s++){var r=o[s];n(r)}else i='<div class="no-data">暂无数据</div>';i&&this.select(".tgc2-stats").append(i)},t.defaultSettings={enable:!1},t}(),Tgc2TimeChart=function(){function t(e,i){var n=this;this.events=[],this.visibleEvents=[],this.start=null,this.end=null,this.tgc2=e,this.settings=$.extend(!0,{},t.defaultSettings,i),this.tgc2.addBeforeDraw(function(){n.beforeDraw()}),this.tgc2.addOnInitEvent(function(){n.initTemplate()}),this.tgc2.addOnResize(function(){n.timeChart&&n.timeChart.resize()})}return t.prototype.getContainer=function(){return this.$container},t.prototype.select=function(t){return this.getContainer().find(t)},t.prototype.beforeDraw=function(){this.buildEvents(),this.drawTimeChart()},t.prototype.buildEvents=function(){var e=this.tgc2.getData();if(e.computerTime){this.events=t.updateEventInfo(e.links),this.start=e.computerTime,this.tgc2.start=this.start;var i=new Date(this.start).getTime();this.visibleEvents=_.filter(this.events,function(t){return!t.hidden&&t.timestamp>=i}),this.end=_.maxBy(this.visibleEvents,"timestamp").time,this.tgc2.end=this.end}else this.events=e.links,this.visibleEvents=this.events;this.buildAvailableData(e)},t.prototype.buildAvailableData=function(t){for(var e=$.extend(!0,{},t),i=_.union(_.map(this.visibleEvents,"from"),_.map(this.visibleEvents,"to")),n=[],a=0,s=e.nodes;a<s.length;a++){var o=s[a];_.indexOf(i,o.id)>=0&&n.push(o)}e.nodes=n;for(var r=_.map(this.visibleEvents,"id"),l=[],c=0,h=e.links;c<h.length;c++){var d=h[c];_.indexOf(r,d.id)>=0&&l.push(d)}e.links=l,this.tgc2.updateAvailableData(e)},t.prototype.drawTimeChart=function(){var t=this,e=this.tgc2.getData(),i=_.countBy(this.events,"time"),n=[];for(var a in i)n.push({key:a,value:i[a]});var s=_.orderBy(n,["key"],["asc"]),o=_.map(s,"key"),r=_.map(s,"value"),l=this.select(".tgc2-timechart"),c=this.settings.settings;c.xAxis[0].data=o,c.dataZoom[0].startValue=e.computerTime,c.dataZoom[0].endValue=o.length-1,c.series[0].data=r,this.timeChart=echarts.init(l[0]),this.timeChart.setOption(c),this.timeChart.on("datazoom",function(){var e=t.timeChart.getOption().dataZoom[0];t.start=o[e.startValue],t.tgc2.start=t.start,t.end=o[e.endValue],t.tgc2.end=t.end;var i=new Date(t.start).getTime(),n=new Date(t.end).getTime();t.visibleEvents=_.filter(t.events,function(t){return t.timestamp>=i&&t.timestamp<=n});var a=t.tgc2.getData();t.tgc2.updateChart(),t.buildAvailableData(a)})},t.prototype.initEvent=function(){this.getContainer().find(".tgc2-timechart-control").on("click",function(){$(this).parent().toggleClass("hide-detail")})},t.prototype.initTemplate=function(){this.settings.enable&&(this.$container=$('<div class="tgc2-timechart-container hide-detail"><button class="tgc2-timechart-control btn btn-primary"><i></i></button><div class="tgc2-timechart"></div></div>'),this.$container.css({top:this.settings.style.top,right:this.settings.style.right,bottom:this.settings.style.bottom,left:this.settings.style.left}),this.tgc2.getContainer().append(this.$container),this.initEvent())},t.updateEventInfo=function(t){for(var e=[],i=0,n=t;i<n.length;i++)for(var a=n[i],s=0,o=a.bsTime;s<o.length;s++){var r=o[s],l=$.extend(!0,{},a),c=new Date(r);l.time=r,l.timestamp=c.getTime(),e.push(l)}return e},t.defaultSettings={enable:!1,style:{top:"auto",right:"350px",bottom:"0",left:"200px"},settings:{color:["#00b38a"],tooltip:{trigger:"item"},grid:{left:"50px",right:"85px",top:"10px",bottom:"50px",containLabel:!0},xAxis:[{type:"category",boundaryGap:!1,interval:0}],yAxis:[{type:"value",splitLine:{show:!1},axisLabel:{show:!1},axisTick:{show:!1},axisLine:{show:!1}}],dataZoom:[{show:!0,realtime:!0,fillerColor:"rgba(0, 179, 138, 0.3)"}],series:[{name:"事件总量",type:"line",stack:"数量",symbolSize:5,areaStyle:{normal:{}}}]}},t}();